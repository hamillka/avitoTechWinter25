# Тестовое задание Avito 2025

Магазин мерча

## Содержание

1. [Описание задачи](#описание-задачи)
2. [Запуск сервиса](#запуск-сервиса)
3. [Детали реализации](#детали-реализации)
4. [Вопросы по заданию, возникшие во время разработки](#вопросы-по-заданию-возникшие-во-время-разработки)
5. [Таблица прогресса](#таблица-прогресса)
6. [Дальнейшее развитие](#дальнейшее-развитие)

## Описание задания

### Проблема

В Авито существует внутренний магазин мерча, где сотрудники могут приобретать товары за монеты (coin).
Каждому новому сотруднику выделяется 1000 монет, которые можно использовать для покупки товаров.
Кроме того, монеты можно передавать другим сотрудникам в знак благодарности или как подарок.

### Задача

Необходимо реализовать сервис, который позволит сотрудникам обмениваться монетками и приобретать на них мерч.
Каждый сотрудник должен иметь возможность видеть:

- Список купленных им мерчовых товаров
- Сгруппированную информацию о перемещении монеток в его кошельке, включая:
    - Кто ему передавал монетки и в каком количестве
    - Кому сотрудник передавал монетки и в каком количестве

### Общие вводные

**Мерч** — это продукт, который можно купить за монетки. Всего в магазине доступно 10 видов мерча.
Каждый товар имеет уникальное название и цену. Ниже приведён список наименований и их цены.

| Название   | Цена |
|------------|------|
| t-shirt    | 80   |
| cup        | 20   |
| book       | 50   |
| pen        | 10   |
| powerbank  | 200  |
| hoody      | 300  |
| umbrella   | 200  |
| socks      | 10   |
| wallet     | 50   |
| pink-hoody | 500  |

Предполагается, что в магазине бесконечный запас каждого вида мерча.

## Запуск сервиса

Сначала необходимо склонировать репозиторий и перейти в директорию:

```bash
git clone https://github.com/hamillka/avitoTechWinter25.git
cd avitoTechWinter25
```

Для деплоя реализован [docker-файл](./Dockerfile) и использован [docker-compose](./docker-compose.yml).
Вместе с сервисом поднимается БД в отдельном контейнере.
Для этого нужно выполнить следующую команду:

```bash
docker-compose up
```

Для удобства написан [make-файл](./Makefile).
С помощью команды `make run` можно запустить базу данных и приложение.
Сервис будет запущен на localhost с портом 8080.

Поскольку работа с приложением требует авторизации, то для удобства тестрования мной создан тестовый пользователь
с именем пользователя **initUser** и паролем **initUserPassword**. Ниже приведен JWT-токен для данного пользователя со
сроком действия до 16.02.2026:

```
Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NzEyMzc2OTksInVzZXJuYW1lIjoiaW5pdFVzZXIifQ.GgQAK-NcWHY-dVs5LN5gO9OMrfjiD2r42ionhce_XB8
```

## Детали реализации

- Стек: Golang, PostgreSQL, Docker
- При разработке был использован
  [API](https://github.com/avito-tech/tech-internship/blob/main/Tech%20Internships/Backend/Backend-trainee-assignment-winter-2025/schema.json).
- В директории [e2e_tests](./e2e_tests) расположены файлы с реализацией E2E-тестов для сценариев покупки мерча,
  передачи монеток другим пользователям, выполнения авторизации и получения информации о пользователе.
  Выполнить тесты можно с помощью команды `make e2e-w-coverage`, при этом приложение будет запущено автоматически.
- В директориях [services/unit_tests](./internal/services/unit_tests) и
  [repositories/unit_tests](./internal/repositories/unit_tests) реализованы unit-тесты для уровня бизнес-логики и уровня
  доступа к данным соответственно. Выполнить тесты можно с помощью команды `make units`.
- Для запуска всех тестов сразу можно выполнить команду `make all_tests`.
- В файле [cicd.yaml](./.github/workflows/cicd.yaml) представлен файл конфигурации CI/CD для автозапуска тестов и
  линтера.
- В файле [.pre-commit-config.yaml](./.pre-commit-config.yaml) представлена конфигурация пре-коммит хука для запуска
  тестов и линтера при новом коммите.
- Реализована поддержка Swagger, которая упрощает работу с API. Маршрут для Swagger: http://localhost:8080/swagger/

### БД

На рисунке ниже представлена схема реализованной мной базы данных `avito_shop_service`.

![](./img/avito_shop_service_db.png "Схема базы данных")

В файле [1-init.sql](./scripts/1-init.sql) приведен SQL-код создания БД.

### Архитектура

На следующем рисунке продемонстрирована архитектура сервиса:

![](./img/avito_shop_service_arch.png "Архитектура сервиса")

Входящий запрос обрабатывается роутером, вызывает соответствующий метод хендлера.
В каждом методе хендлера вызывается необходимый метод сервиса бизнес-логики, а в методах сервиса
вызываются методы репозиториев уровня доступа к данным.

### Линтер

В [файле](./.golangci.yaml) описана конфигурация линтера, которая следит за качеством кода и помогает исправлять
логические и стилистические ошибки во время разработки.

### Нагрузочное тестирование

В файле [load.js](./load_testing/load.js) представлен сценарий выполнения нагрузочного тестирования с помощью Grafana
K6. Нагрузка: 1k RPS в течение 5 минут. Тестируется ручка `/api/info`. БД заполняется 100k пользователями с помощью
скрипта [db_100k_users.go](./load_testing/db_100k_users.go). Затем необходимо выполнить
команду `k6 run ./load_testing/load.js`. Для упрощения запуска все эти действия вынесены в команду `make load_testing`.

Результаты нагрузочного тестирования (5 минут нагрузки) представлены на следующем изображении:

![Результаты нагрузочного тестирования (5 минут)](./img/load_result_5min.jpg)

## Вопросы по заданию, возникшие во время разработки

- Поскольку по заданию нужно отслеживать перемещение монет (насколько я понял из задания, истории покупок тоже нужно
  фиксировать), я решил создать пользователя AvitoShop, который будет "продавцом" мерча. Все монеты при покупке мерча
  приходят на счет этого пользователя. Покупать сам у себя мерч AvitoShop не может.

## Таблица прогресса

| Задача                                                              | Прогресс | Комментарий                                                                                                                                         |
|---------------------------------------------------------------------|:--------:|-----------------------------------------------------------------------------------------------------------------------------------------------------|
| **Метод регистрации/входа в систему**                               |    ✅     |                                                                                                                                                     |
| **Метод отправки монеток другому пользователю**                     |    ✅     |                                                                                                                                                     |
| **Метод покупки мерча**                                             |    ✅     |                                                                                                                                                     |
| **Метод получения информации об инвентаре, монетках и транзакциях** |    ✅     |                                                                                                                                                     |
| **Авторизация**                                                     |    ✅     | Был реализован middleware, который проверяет JWT-токен, переданный в Header\'е с именем `Authorization`, и разрешает или запрещает действие клиенту |
| **E2E-тесты**                                                       |    ✅     | Были созданы E2E-тесты для сценариев отправки монет и покупки мерча                                                                                 |
| **Покрытие проекта тестами >40%**                                   |    ✅     |                                                                                                                                                     |
| **Запуск в docker**                                                 |    ✅     |                                                                                                                                                     |
| **Дополнительные тесты**                                            |    ✅     | Были реализованы E2E-тесты для сценария входа в систему и сценария получения информации                                                             |
| **Нагрузочное тестирование**                                        |    ✅     |                                                                                                                                                     |
| **Линтер**                                                          |    ✅     | Описана конфигурация линтера                                                                                                                        |
| **Swagger**                                                         |    ✅     |                                                                                                                                                     |
| **CI/CD**                                                           |    ✅     | Описана конфигурация CI/CD-файла                                                                                                                    |
| **Pre-Commit Hooks**                                                |    ✅     | Описана конфигурация для пре-коммит хука                                                                                                            |

## Дальнейшее развитие

- Привязать Redis для кеширования запросов
- Сделать пароли в БД хэшируемыми, чтобы не хранить их в открытом виде :(
